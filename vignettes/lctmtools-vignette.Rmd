---
title: "LCTMtools: Latent Class Trajectory Modelling tools An R Package"
author: "Hannah Lennon"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


### Motivation

Latent class trajectory modelling (LCTM) is a relatively new methodology in epidemiology to describe life-course exposures, which simplifies heterogeneous populations into homogeneous patterns or classes. However, for a given dataset, it is possible to derive scores of different models based on number of classes, model structure and trajectory property. Here, we rationalise a systematic framework to derive a ‘core’ favoured model. We recently outlined a framework to construct and select a ‘core’ LCTM, which will facilitate generalisability of results in future studies.

All statistical (R and SAS) codes used to implement Latent Class Trajectory Modelling and the tools described in the manuscript “A framework to construct and interpret latent class trajectory modelling” are available in an R package called ‘LCTMtools’.

To install the R package, in the R console use the command

> devtools::install_github("hlennon/LCTMtools")



### References

Lennon H, Kelly S, Sperrin M, et al Framework to construct and interpret latent class trajectory modelling BMJ Open 2018;8:e020683. doi: 10.1136/bmjopen-2017-020683

Available at https://bmjopen.bmj.com/content/8/7/e020683.



### Example

An example (simulated) dataset ‘bmi’ and ‘bmi_long’ (long format version) is provided to describe the steps throughout.

```{r}
library(LCTMtools)
data(bmi_long, package = "LCTMtools")
```

Fit a two class trajectory model for age allowing for random quadratic effects using for example the lcmm R package


```{r mod2, cache=TRUE}
library(lcmm)
set.seed(100)
model2class <- hlme(fixed = bmi ~ age + I(age), 
                    mixture = ~ age, 
                    random= ~ age,
                    nwg=TRUE, ng=2, subject="id", data=bmi_long)
```

```{r  mod2pp, cache=TRUE}
postprob(model2class)
```


```{r  mod2tk, cache=TRUE}
LCTMtoolkit(model2class)
```


We can also compare models

```{r  mod3, cache=TRUE}
set.seed(100)
model3class <- hlme(fixed = bmi ~ age + I(age^2), 
                    mixture = ~ age, 
                    random= ~ age,
                    nwg=TRUE, ng=3, subject="id", data=bmi_long)
```


```{r mod23, cache=TRUE}
LCTMcompare(model2class, model3class)
```


# Eight step framework for Latent class trajectory modelling
Example: modelling BMI as a function of age. Latent classes were used to identify subgroups of participants with distinct trajectories. 



We used maximum likelihood approaches to fit the model with the ‘hlme’ function from ‘lcmm’ library in the R software environment and cross-checked results using the ‘PROC TRAJ’ function in ‘SAS traj’ library (SAS Institute, Cary, North Carolina, USA)20 (online supplementary table S1).


## STEP 1:
We initially constructed a scoping model provisionally selecting the plausible number of classes based on available literature; in the context of BMI trajectories, we used K=5 classes as reported elsewhere.

To determine the initial working model structure of random effects, we followed the rationale of Verbeke and Molenbergh and examined the shape of standardised residual plots for each of the five classes in a model with no random effects. If the residual profile could be approximated by a flat, straight line or a curve, then a random intercept, slope or quadratic term, respectively, were considered. Preliminary plots suggested preference for a quadratic random effects model (supplementary figure S1).

```{r}
8*7
```




## Step 2
We refined the preliminary working model from step 1 to determine the optimal number of classes, testing K=1–7. The number of classes chosen was based on the lowest Bayesian information criteria (BIC).



##Step 3
We further refined the model using the favoured K derived in step 2, testing for the optimal model structure. We tested seven models (detailed in online supplemen- tary table S2), ranging from a simple fixed effects model (model A) through a rudimentary method that allows the residual variances to vary between classes (model B) to a suite of five random effects models with different variance structures (models C–G).

##Step 4
We then performed a number of model adequacy assess- ments. First, for each participant, we calculated the poste- rior probability of being assigned to each trajectory class and assigned the individual to the class with the highest probability. An average of these maximum posterior prob- ability of assignments (APPA) above 70%, in all classes, is regarded as acceptable.6 We further assessed model adequacy using odds of correct classification, mismatch


