---
title: "LCTMtools: Latent Class Trajectory Modelling tools An R Package"
author: "Hannah Lennon, Charlotte Watson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


### Motivation

Latent class trajectory modelling (LCTM) is a relatively new methodology in epidemiology to describe life-course exposures, which simplifies heterogeneous populations into homogeneous patterns or classes. However, for a given dataset, it is possible to derive scores of different models based on number of classes, model structure and trajectory property. Here, we rationalise a systematic framework to derive a core favoured model. We recently outlined a framework to construct and select a core LCTM, which will facilitate generalisability of results in future studies.

All statistical (R and SAS) codes for the tools used to guide selection of Latent Class Trajectory Modelling are described in the manuscript "A framework to construct and interpret latent class trajectory modelling" are available in an R package called LCTMtools.

To install the R package, in the R console use the command

> devtools::install_github("hlennon/LCTMtools")




### References

Lennon H, Kelly S, Sperrin M, et al Framework to construct and interpret latent class trajectory modelling BMJ Open 2018;8:e020683. doi: 10.1136/bmjopen-2017-020683

Available at https://bmjopen.bmj.com/content/8/7/e020683.



### Example

An example (simulated) dataset *bmi* is provided to describe the steps throughout, and *bmi_long* is the long format version. 
Five classes of BMI trajectories across adult lifetime for N=10,000 individuals.

```{r}
library(LCTMtools)
data(bmi_long, package = "LCTMtools")
```

Fit a two class trajectory model for age allowing for random quadratic effects using the *lcmm* R package (Prost-Lima et al., 2017)



# An example of the eight step framework for Latent class trajectory modelling

Example: modelling BMI as a function of age. Latent classes were used to identify subgroups of participants with distinct trajectories. 

The equations models A to G, to model longitdinal outcome $y_{ijk}$, for $k=1:K,$ classes, for individual $i$, at time point $j$, $t_j$ are  


Model A:   
$$y_{ijk}=\beta_0^{(k)} + \beta_1^{(k)} t_{ij} + \beta_2^{(k)} t^2_{ij} + \epsilon_{ij}}, $$
where the residual variance is assumed equal across all classes, $\epsilon_{ij}\sim N(0, \sigma^2)$.  


Model B:   

$$y_{ijk}=\beta_0^{(k)} + \beta_1^{(k)} t_{ij} + \beta_2^{(k)} t^2_{ij} + \epsilon_{ijk}}, $$
where the residual variances are assumed different across $\epsilon_{ijk} \sim N(0, \sigma_k^2)$.  


Model C:   
For $k=1:K,$ classes, for individual $i$, at time point $j$, $t_j$, 
$$y_{ijk}=\beta_0^{(k)} + \beta_1^{(k)} t_{ij} + \beta_2^{(k)} t^2_{ij} + b_0^{(k)}  +  \epsilon_{ij}}, $$
where the random effect distibruion $b_0 \sim N(0, B)$.  


Model D:   
For $k=1:K,$ classes, for individual $i$, at time point $j$, $t_j$, 
$$y_{ijk}=\beta_0^{(k)} + \beta_1^{(k)} t_{ij} + \beta_2^{(k)} t^2_{ij} + b_0^{(k)} + + b_1^{(k)} t_{ij} \epsilon_{ij}}, $$
where the random effects assumed to be distributed as $b_0 \sim N(0, B)$.  



Model E:   
For $k=1:K,$ classes, for individual $i$, at time point $j$, $t_j$, 
$$y_{ijk}=\beta_0^{(k)} + \beta_1^{(k)} t_{ij} + \beta_2^{(k)} t^2_{ij} + b_0^{(k)} + + b_1^{(k)} t_{ij} \epsilon_{ij}}, $$
where the random effects assumed to be distributed as $b_0 \sim N(0, B)$.  


Model F:   
For $k=1:K,$ classes, for individual $i$, at time point $j$, $t_j$, 
$$y_{ijk}=\beta_0^{(k)} + \beta_1^{(k)} t_{ij} + \beta_2^{(k)} t^2_{ij} + b_0^{(k)} + + b_1^{(k)} t_{ij} \epsilon_{ij}}, $$
where the random effects assumed to be distributed as $b_0 \sim N(0, B)$.  




Model | Description | Interpretation | Software | Command |   
     
A  | Fixed effects homoscedastic | No random effects – with the interpretation that any deviation of an individuals trajectory from its mean class trajectory is due to random error only
 | SAS traj
PROC TRAJ | 
 (common residual variance across classes)
          
    
B | 
 | Fixed effects
 | (class-specific residual variances)
 | heteroscedastic
 | The same interpretation as Model A with random errors that can be larger and smaller in different classes.
 | R mmlcr

 
         
    
C
Random intercept
The interpretation is allowing individuals to vary in initial weight but each class member is assumed to follow the same shape and magnitude of the mean trajectory
SAS traj
PROC TRAJ
(7)
          
    
D
Random slope
Allowing individuals to vary in initial weight and slope of the mean trajectory but same curvature as trajectory
SAS traj
PROC TRAJ
(7)
          
    
E
Random quadratic – Common variance structure across classes
Additional freedom of allowing individuals to vary within classes by initial weight, shape and magnitude, however each class is assumed to have the same amount of variability
R lcmm
hlme/lcmm
         
    
F
Random quadratic – Proportionality constraint to allow variance structures to vary across classes
Increasing flexibility of model E as variance structures are allowed to differ up to a multiplicative factor to allow some classes to have larger or smaller within-class variances. This model is can be thought of more parsimonious version of model G from (reducing the number of variance-covariance parameters to be estimated from 6xK parameters to 6+(K-1) parameters.
R lcmm
hlme/lcmm
          
   


We used maximum likelihood approaches to fit the model with the *hlme* function from the *lcmm* library in the R software environment and cross-checked results using the PROC TRAJ function in SAS traj library (SAS Institute, Cary, North Carolina, USA).


## STEP 1:
We initially constructed a scoping model provisionally selecting the plausible number of classes based on available literature; in the context of BMI trajectories, we used $K=5$ classes as reported elsewhere.

To determine the initial working model structure of random effects, we followed the rationale of Verbeke and Molenbergh and examined the shape of standardised residual plots for each of the five classes in a model with no random effects. If the residual profile could be approximated by a flat, straight line or a curve, then a random intercept, slope or quadratic term, respectively, were considered. Preliminary plots suggested preference for a quadratic random effects model (supplementary figure S1).


#' Step 1: Select the form of the random effect structure

Fit a latent class modelel with no random effects, e.g. in the lcmm package in R this can be done by specifying $\verb|random=~-1|$. As a rough working modelel, chose fixed effects form and number of likely classes, e.g. here k = 5.
```{r}
data(bmi_long)
model1 <- lcmm::hlme(fixed=bmi~1+age+I(age^2),
                   mixture = ~1+age+I(age^2),
                   random=~-1,
                   subject="id",
                   ng=5,
                   nwg=FALSE, 
                   data=data.frame(bmi_long[1:200,])
                   )
```


We then feed the fitted model to the step1 function in LCTMtools to examine the class speciifc residuals. 

```{r eval=FALSE, fig.align="center", fig.height=3, fig.width=5, message=FALSE}
residualplot_step1(model1)
```



## STEP 2
We refined the preliminary working model from step 1 to determine the optimal number of classes, testing $K=1, ... 7$. 
The number of classes chosen can be chosen here based on the lowest Bayesian information criteria (BIC).



